&НаСервере
Функция ВыполнитьНаСервере(ТабличныйДокумент)
	Макет = РеквизитФормыВЗначение("Объект").ПолучитьМакет("Макет");
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка|ШапкаТаб");
	ОбластьКлиент = Макет.ПолучитьОбласть("Шапка|Клиент");
	ОбластьТовар = Макет.ПолучитьОбласть("Детали|Товар");
	ОбластьВыручка = Макет.ПолучитьОбласть("Детали|Выручка");
	
	ТабличныйДокумент.Вывести(ОбластьШапка);
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ВыручкаИСебестоимостьПродажОбороты.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
		|	ВыручкаИСебестоимостьПродажОбороты.АналитикаУчетаПоПартнерам.Партнер КАК АналитикаУчетаПоПартнерамПартнер,
		|	ВыручкаИСебестоимостьПродажОбороты.АналитикаУчетаНоменклатуры.Номенклатура КАК АналитикаУчетаНоменклатурыНоменклатура
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты КАК ВыручкаИСебестоимостьПродажОбороты
		|ИТОГИ
		|	СУММА(СуммаВыручкиОборот)
		|ПО
		|	АналитикаУчетаНоменклатурыНоменклатура,
		|	АналитикаУчетаПоПартнерамПартнер";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаТовар = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "АналитикаУчетаНоменклатурыНоменклатура");
	
	Пока ВыборкаТовар.Следующий() Цикл
		ВыборкаЗаполнитьКолонки = ВыборкаТовар.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "АналитикаУчетаПоПартнерамПартнер", "ВСЕ");
		Пока ВыборкаЗаполнитьКолонки.Следующий() Цикл
			ОбластьКлиент.Параметры.КлиентПредставление = ВыборкаЗаполнитьКолонки.АналитикаУчетаПоПартнерамПартнер;
			ТабличныйДокумент.Присоединить(ОбластьКлиент);	
		КонецЦикла;
		Прервать;
	КонецЦикла;
	
	ОбщегоНазначения.СообщитьПользователю("Конец развертывания колонок");
	
	ВыборкаАналитикаУчетаПоНоменклатуре = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "АналитикаУчетаНоменклатурыНоменклатура");
	Пока ВыборкаАналитикаУчетаПоНоменклатуре.Следующий() Цикл
		ОбластьТовар.Параметры.ПредставлениеТовар = ВыборкаАналитикаУчетаПоНоменклатуре.АналитикаУчетаНоменклатурыНоменклатура;
		ТабличныйДокумент.Вывести(ОбластьТовар);
		ВыборкаДетЗаписи = ВыборкаАналитикаУчетаПоНоменклатуре.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "АналитикаУчетаПоПартнерамПартнер", "ВСЕ");
		Пока ВыборкаДетЗаписи.Следующий() Цикл
			ОбластьВыручка.Параметры.ВыручкаОборот = ВыборкаДетЗаписи.СуммаВыручкиОборот;
			ТабличныйДокумент.Присоединить(ОбластьВыручка);	
		КонецЦикла;		
	КонецЦикла;
	Возврат  ТабличныйДокумент;	
КонецФункции
